# ロードバランサー

Ingress Load Balancerは、TLS（1.0から1.2）プロトコルを使用したプロキシされたHTTP（S）接続を介して、環境のサービスへのインターネットアクセスを提供します。 各ロードバランサーには、カスタムドメインを設定できる静的IPがあります。

![図1：カスタムドメインを使用して環境のロードバランサーを設定できます。](./load-balancer/images/01.png)

専用のロードバランサーを使用すると、ポート設定、カスタムSSL証明書、CDNなどの拡張機能が無数に提供されます。 以下は、 `LCP.json` ファイルのロードバランサーの設定例です。

``` json
{
  "id": "webserver",
  "loadBalancer": {
    "cdn": true,
    "targetPort": 80,
    "customDomains": ["acme.liferay.cloud"],
    "ssl": {
      "key": "...",
      "crt": "..."
    }
  }
}
```

## シーディーエヌ

Liferayのコンテンツ配信ネットワーク（CDN）は、DXP Cloudで提供される組み込み機能です。 このCDNはコンテンツをグローバルにキャッシュし、配信速度を大幅に向上させます。 このCDNはデフォルトで無効になっていますが、 `LCP.json`で有効にできます。

``` json
"cdn": true
```

![図2：CDNのステータスは[ネットワーク]ページに表示されます。](./load-balancer/images/02.png)

## 港

ロードバランサーのサービスエンドポイントがどの内部ポート(`targetPort`)を経由するかを設定できます。 DXP Cloudは、提供するサービスに適したポートを自動的に設定します。

``` json
"targetPort".3000
```

![図3：ロードバランサーは、ポート設定を示しています。](./load-balancer/images/03.png)

## カスタムSSL

サービスのロードバランサー属性を指定すると、このパターンにちなんだ名前のサービスエンドポイントが追加されます。

  - `<SERVICE-NAME>-<PROJECT-NAME>-<ENVIRONMENT-NAME>.lfr.cloud`

次の例を考えてみましょう：

  - サービス：ウェブサーバー
  - プロジェクト：acme
  - 環境：prd
  - サービスエンドポイント名： `webserver-acme-prd.lfr.cloud`

`.lfr.cloud` にあるDXP Cloudのインフラストラクチャによって作成されたこれらのドメインは、ネットワークページのSSL証明書セクションに表示されないワイルドカード証明書によってカバーされています。

また、コンソールまたは `LCP.json`を介して追加されたすべてのカスタムドメインの場合、Liferay DXP Cloudは [Let's Encrypt](https://letsencrypt.org/) 到達して、自動的に更新され、作成したすべてのカスタムドメインをカバーする証明書を取得します。

ただし、独自のSSL証明書を追加して、作成するカスタムドメインをカバーできます。 `LCP.json`追加できるカスタム証明書は1つだけなので、すべてのカスタムドメインをカバーする必要があります。 また、サービスのカスタムドメインには、Let's Encrypt が提供する証明書、または `LCP.json`で指定したカスタムドメインの証明書が一度に 1 つしか存在しません。 両方が存在する場合は、カスタム証明書が優先されます。

カスタム証明書を管理する必要があることに注意してください。 これには、新しいカスタムドメインが追加されたときに更新され、期限切れになったときに更新されます。 カスタム証明書を追加するには、Base64形式でキーと証明書を指定します。

``` json
"ssl": {
  "key": "...",
  "crt": "..."
}
```

```{warning}
DXP Cloudでは、カプセル化の境界線を含む、適切にフォーマットされたPEM証明書と鍵のみを受け付けています。 詳細は [spec](https://tools.ietf.org/html/rfc4648#section-4) を参照してください。
```

``` xml
-----BEGIN CERTIFICATE-----
base64encodedcertificate
-----END CERTIFICATE-----
```

[ネットワーク]ページには、サービスごとに最大1つのカスタム証明書が表示されます。 詳細は、 [カスタムドメイン](./custom-domains.md)参照してください。

![図4：DXP Cloudは、カスタムドメインをカバーするSSL証明書のステータスを示しています。](./load-balancer/images/04.png)

## 環境変数リファレンス

| 名前         | Value                                    | 説明                                        |
| ---------- | ---------------------------------------- | ----------------------------------------- |
| `ＣＤＮ`      | false                                    | CDNはデフォルトで無効になっています。 `設定することで有効にできますtrue` |
| `カスタムドメイン` | \ ["example.com"、 "www.example.com" \] | カスタムドメインの名前。 複数をリストできます                   |
| `ターゲットポート` | 3000                                     | ロードバランサーのポート番号                            |
| `key`      |                                          | SSL証明書のキー                                 |
| `crt`      |                                          | Base64形式のSSL証明書のcrt                       |
